name: SKKU Notice Bot Automation

on:
  schedule:
    # 정각이 아닌 '23분'이나 '47분'처럼 아무도 안 쓸 법한 분 단위 선택
    # 3시간마다 체크하여 건너뛰기 방지 (KST 기준 09:23, 12:23, 15:23 ...)
    - cron: '23 */3 * * *'
  workflow_dispatch:      # 우리가 원할 때 수동 실행 버튼 생성

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install requests beautifulsoup4
      - name: List files (Check if files exist)
        run: ls -R  # 서버에 있는 모든 파일 목록을 출력해줌
      - name: Run Bot
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: python skku_bot.py
      - name: Run Bot
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }} # 비밀 주소 연결
        run: python skku_bot.py
      - name: Update DB Files
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 1. 새로 생성/수정된 파일들을 먼저 내역에 추가합니다.
          git add last_notice_*.txt
          
          # 2. 추가된 내용을 '내 컴퓨터(서버)'에 먼저 저장(확정)합니다. 
          # 수정사항이 없으면 그냥 종료하도록 || exit 0 를 붙입니다.
          git commit -m "Update notice IDs" || exit 0
          
          # 3. 이제 확정된 내역이 있으니, 서버의 최신 내역을 가져와서 내 것 뒤에 붙입니다.
          # 이제는 파일이 '추적 중'인 상태라 충돌 없이 잘 합쳐집니다.
          git pull --rebase origin main
          
          # 4. 합쳐진 최종본을 서버로 올립니다.
          git push
